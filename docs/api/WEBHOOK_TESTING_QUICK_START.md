# Stripe Webhookæµ‹è¯•å¿«é€Ÿå¼€å§‹

## ğŸš€ å¿«é€Ÿæµ‹è¯•ï¼ˆæ¨èï¼‰

### 1. ä½¿ç”¨Stripe CLIå¿«é€Ÿæµ‹è¯•

```bash
# å¿«é€Ÿæµ‹è¯•webhookäº‹ä»¶
npm run test:webhook
```

è¿™ä¸ªå‘½ä»¤ä¼šï¼š
- æ£€æŸ¥Stripe CLIæ˜¯å¦å®‰è£…
- æ£€æŸ¥æ˜¯å¦å·²ç™»å½•Stripe
- è‡ªåŠ¨è§¦å‘æµ‹è¯•äº‹ä»¶
- æ˜¾ç¤ºæµ‹è¯•ç»“æœ

### 2. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€

```bash
# æ£€æŸ¥ç”¨æˆ·è®¢é˜…çŠ¶æ€å’Œè¯•ç”¨æ¬¡æ•°
npm run test:user-status
```

## ğŸ”§ è¯¦ç»†æµ‹è¯•æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨Stripe CLIç›‘å¬å™¨

```bash
# å¯åŠ¨webhookç›‘å¬å™¨ï¼ˆéœ€è¦ä¸¤ä¸ªç»ˆç«¯ï¼‰
# ç»ˆç«¯1: å¯åŠ¨åº”ç”¨
npm run dev

# ç»ˆç«¯2: å¯åŠ¨webhookç›‘å¬å™¨
npm run test:webhook:listen
```

ç„¶ååœ¨ç¬¬ä¸‰ä¸ªç»ˆç«¯ä¸­è§¦å‘äº‹ä»¶ï¼š
```bash
# è§¦å‘è®¢é˜…æˆåŠŸäº‹ä»¶
stripe trigger checkout.session.completed

# è§¦å‘è®¢é˜…æ›´æ–°äº‹ä»¶
stripe trigger customer.subscription.updated

# è§¦å‘è®¢é˜…å–æ¶ˆäº‹ä»¶
stripe trigger customer.subscription.deleted
```

### æ–¹æ³•2: ä½¿ç”¨æ¨¡æ‹Ÿwebhook

```bash
# è¿è¡Œå®Œæ•´çš„æ¨¡æ‹Ÿæµ‹è¯•æµç¨‹
npm run test:webhook:simulate
```

### æ–¹æ³•3: æµ‹è¯•è¯•ç”¨æ¬¡æ•°æ›´æ–°é€»è¾‘

```bash
# æµ‹è¯•è¯•ç”¨æ¬¡æ•°æ›´æ–°é€»è¾‘
npm run test:usage-update
```

## ğŸ“‹ å¯ç”¨çš„npmè„šæœ¬

| è„šæœ¬ | æè¿° |
|------|------|
| `npm run test:webhook` | å¿«é€ŸStripe webhookæµ‹è¯• |
| `npm run test:webhook:listen` | å¯åŠ¨Stripe CLIç›‘å¬å™¨ |
| `npm run test:webhook:simulate` | è¿è¡Œæ¨¡æ‹Ÿwebhookæµ‹è¯• |
| `npm run test:user-status` | æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ |
| `npm run test:usage-update` | æµ‹è¯•è¯•ç”¨æ¬¡æ•°æ›´æ–°é€»è¾‘ |

## ğŸ¯ æµ‹è¯•æµç¨‹

### å®Œæ•´æµ‹è¯•æµç¨‹

1. **å¯åŠ¨åº”ç”¨**:
   ```bash
   npm run dev
   ```

2. **å¿«é€Ÿæµ‹è¯•webhook**:
   ```bash
   npm run test:webhook
   ```

3. **æ£€æŸ¥ç”¨æˆ·çŠ¶æ€**:
   ```bash
   npm run test:user-status
   ```

4. **éªŒè¯ç»“æœ**:
   - è®¢é˜…çŠ¶æ€åº”è¯¥æ›´æ–°ä¸ºæ´»è·ƒ
   - è¯•ç”¨æ¬¡æ•°åº”è¯¥æ›´æ–°ä¸ºå¯¹åº”è®¡åˆ’çš„æ•°é‡
   - åº”è¯¥çœ‹åˆ°ç›¸å…³çš„æ—¥å¿—è¾“å‡º

### æ‰‹åŠ¨æµ‹è¯•æµç¨‹

1. **ä½¿ç”¨æµ‹è¯•æ¨¡å¼ç™»å½•**:
   - è®¿é—® `http://localhost:3000/login`
   - ç‚¹å‡»"æˆ–ä½¿ç”¨æµ‹è¯•æ¨¡å¼ç™»å½•"

2. **è§¦å‘è®¢é˜…**:
   - ç‚¹å‡»ä»»æ„è®¢é˜…è®¡åˆ’
   - å®Œæˆæ”¯ä»˜æµç¨‹

3. **å‘é€webhookäº‹ä»¶**:
   ```bash
   stripe trigger checkout.session.completed
   ```

4. **æ£€æŸ¥çŠ¶æ€æ›´æ–°**:
   ```bash
   npm run test:user-status
   ```

## ğŸ” é¢„æœŸç»“æœ

### è®¢é˜…æˆåŠŸå
- âœ… è®¢é˜…è®¡åˆ’: `basic`/`pro`/`enterprise`
- âœ… è®¢é˜…çŠ¶æ€: `æ´»è·ƒ`
- âœ… è¯•ç”¨æ¬¡æ•°: å¯¹åº”è®¡åˆ’çš„æ¬¡æ•°
- âœ… Stripeå®¢æˆ·IDå’Œè®¢é˜…IDå·²è®¾ç½®

### è®¢é˜…å–æ¶ˆå
- âœ… è®¢é˜…è®¡åˆ’: `free`
- âœ… è®¢é˜…çŠ¶æ€: `éæ´»è·ƒ`
- âœ… è¯•ç”¨æ¬¡æ•°: `100` (å…è´¹ç”¨æˆ·)

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Stripe CLIæœªå®‰è£…**:
   ```bash
   # ä¸‹è½½å¹¶å®‰è£…Stripe CLI
   # ä» https://stripe.com/docs/stripe-cli ä¸‹è½½
   ```

2. **æœªç™»å½•Stripe**:
   ```bash
   stripe login
   ```

3. **åº”ç”¨æœªè¿è¡Œ**:
   ```bash
   npm run dev
   ```

4. **webhookç«¯ç‚¹ä¸å¯è¾¾**:
   - ç¡®ä¿åº”ç”¨åœ¨localhost:3000è¿è¡Œ
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹åº”ç”¨æ—¥å¿—**:
   - æ£€æŸ¥ç»ˆç«¯ä¸­çš„æœåŠ¡å™¨æ—¥å¿—
   - æŸ¥çœ‹webhookå¤„ç†æ—¥å¿—

2. **æŸ¥çœ‹Stripe Dashboard**:
   - è¿›å…¥Webhooksé¡µé¢
   - æŸ¥çœ‹äº‹ä»¶æ—¥å¿—

3. **ä½¿ç”¨Stripe CLIæ—¥å¿—**:
   ```bash
   stripe logs tail
   ```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `STRIPE_WEBHOOK_TESTING_GUIDE.md` - è¯¦ç»†çš„webhookæµ‹è¯•æŒ‡å—
- `SUBSCRIPTION_STATUS_UPDATE_FIX.md` - è®¢é˜…çŠ¶æ€æ›´æ–°ä¿®å¤è¯´æ˜
- `SUBSCRIPTION_USAGE_UPDATE_GUIDE.md` - è¯•ç”¨æ¬¡æ•°æ›´æ–°æŒ‡å—

## ğŸ‰ æˆåŠŸæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—è¾“å‡ºæ—¶ï¼Œè¯´æ˜webhookæµ‹è¯•æˆåŠŸï¼š

```
âœ… ç”¨æˆ· 68bfc35e2c9a8cc9d8d876f6 è®¢é˜… basic è®¡åˆ’ï¼Œè¯•ç”¨æ¬¡æ•°æ›´æ–°ä¸º: 500
ğŸ‰ å¼€å‘ç¯å¢ƒï¼šç”¨æˆ· 68bfc35e2c9a8cc9d8d876f6 è®¢é˜…çŠ¶æ€å·²æ›´æ–°ä¸º basic
```

ç°åœ¨ä½ å¯ä»¥å¼€å§‹æµ‹è¯•Stripe webhookåŠŸèƒ½äº†ï¼

