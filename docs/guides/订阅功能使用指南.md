# 订阅功能使用指南

## 概述

本指南介绍如何使用新实现的 Stripe 订阅功能。系统包含完整的订阅管理、使用量跟踪、支付处理和日志记录功能。

当完成一个功能后-》不断的测试-》不断的修复-》直到该功能完成并解决所有的问题

## API 端点

### 1. 订阅管理

#### 创建订阅
```http
POST /api/billing/checkout
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "plan": "basic" | "pro" | "enterprise"
}
```

#### 获取订阅状态
```http
GET /api/billing/subscription
Authorization: Bearer <jwt_token>
```

#### 更新订阅计划
```http
PUT /api/billing/subscription
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "plan": "pro"
}
```

#### 取消订阅
```http
DELETE /api/billing/subscription
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "cancelAtPeriodEnd": true
}
```

### 2. 使用量管理

#### 获取使用量统计
```http
GET /api/billing/usage
Authorization: Bearer <jwt_token>
```

#### 记录使用量
```http
POST /api/billing/usage
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "operation": "transform",
  "count": 1
}
```

#### 检查使用量限制
```http
HEAD /api/billing/usage?operation=transform&count=1
Authorization: Bearer <jwt_token>
```

### 3. 日志查询

#### 获取订阅日志
```http
GET /api/billing/logs?type=subscription&limit=50&offset=0
Authorization: Bearer <jwt_token>
```

#### 获取支付历史
```http
GET /api/billing/logs?type=payment&limit=50&offset=0
Authorization: Bearer <jwt_token>
```

#### 获取订阅记录
```http
GET /api/billing/logs?type=records
Authorization: Bearer <jwt_token>
```

#### 获取统计信息
```http
GET /api/billing/logs?type=stats
Authorization: Bearer <jwt_token>
```

### 4. 统计信息

#### 获取用户统计
```http
GET /api/billing/stats
Authorization: Bearer <jwt_token>
```

### 5. 客户门户

#### 打开 Stripe 客户门户
```http
POST /api/billing/portal
Authorization: Bearer <jwt_token>
```

## 订阅计划

### 免费计划 (Free)
- 转换次数：100 次
- 文件大小限制：2MB
- 功能：基础功能

### 基础计划 (Basic)
- 转换次数：500 次/月
- 文件大小限制：5MB
- 功能：标准分辨率、历史保存、邮件支持
- 价格：$9.99/月

### 专业计划 (Pro)
- 转换次数：2000 次/月
- 文件大小限制：10MB
- 功能：高分辨率、批量处理、优先支持
- 价格：$19.99/月

### 企业计划 (Enterprise)
- 转换次数：无限制
- 文件大小限制：50MB
- 功能：最高分辨率、API访问、定制开发
- 价格：$49.99/月

## 使用量检查

系统会在每次图片转换时自动检查使用量限制：

1. **免费用户**：检查是否超过 100 次限制
2. **付费用户**：检查是否超过订阅计划限制
3. **企业用户**：无限制

如果超出限制，API 会返回 403 错误和详细信息。

## 中间件使用

### 订阅验证中间件
```typescript
import { requireSubscription } from '@/app/middleware/subscription';

// 在 API 路由中使用
export const middleware = requireSubscription('pro');
```

### 使用量检查中间件
```typescript
import { checkUsageLimit } from '@/app/middleware/usage';

// 在 API 路由中使用
export const middleware = checkUsageLimit('transform', 1);
```

## 服务类使用

### SubscriptionService
```typescript
import { SubscriptionService } from '@/app/lib/services/SubscriptionService';

// 获取订阅状态
const status = await SubscriptionService.getSubscriptionStatus(userId);

// 检查使用量限制
const canUse = await SubscriptionService.checkUsageLimit(userId, 'transform', 1);

// 记录使用量
await SubscriptionService.recordUsage(userId, 'transform', 1);
```

### LoggingService
```typescript
import { LoggingService } from '@/app/lib/services/LoggingService';

// 记录订阅操作
await LoggingService.logSubscription({
  userId,
  action: 'created',
  toPlan: 'pro',
  status: 'success'
});

// 获取用户日志
const logs = await LoggingService.getUserSubscriptionLogs(userId, 50, 0);
```

## Webhook 事件

系统处理以下 Stripe Webhook 事件：

- `checkout.session.completed` - 订阅创建成功
- `customer.subscription.updated` - 订阅更新
- `customer.subscription.deleted` - 订阅取消
- `invoice.payment_failed` - 支付失败
- `invoice.payment_succeeded` - 支付成功

## 环境变量

确保设置以下环境变量：

```env
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxx
STRIPE_PRICE_ID_BASIC=price_xxx
STRIPE_PRICE_ID_PRO=price_xxx
STRIPE_PRICE_ID_ENTERPRISE=price_xxx
APP_BASE_URL=http://localhost:3000
JWT_SECRET=your-secret-key
```

## 错误处理

### 常见错误码

- `401` - 未授权（缺少或无效的 JWT token）
- `403` - 使用量限制超出
- `404` - 用户或订阅未找到
- `400` - 请求参数错误
- `500` - 服务器内部错误

### 错误响应格式

```json
{
  "error": "Usage limit exceeded",
  "details": {
    "currentUsage": 100,
    "limit": 100,
    "remaining": 0,
    "operation": "transform"
  }
}
```

## 测试

### 本地测试

1. 使用 Stripe CLI 转发 webhook 事件：
```bash
stripe listen --forward-to localhost:3000/api/billing/webhook
```

2. 使用测试卡号：`4242 4242 4242 4242`

3. 测试各种订阅场景：
   - 创建订阅
   - 更新计划
   - 取消订阅
   - 支付失败处理

### 生产环境

1. 配置生产环境的 Stripe 密钥
2. 设置 webhook 端点
3. 监控日志和错误

## 监控和日志

系统提供完整的日志记录：

- 订阅操作日志
- 支付信息记录
- 使用量统计
- 错误和异常日志

可以通过管理 API 查看统计信息：

```http
GET /api/admin/subscriptions?type=overview
Authorization: Bearer <admin_token>
```

## 故障排除

### 常见问题

1. **Webhook 验证失败**
   - 检查 `STRIPE_WEBHOOK_SECRET` 是否正确
   - 确认 webhook 端点 URL 正确

2. **订阅状态不同步**
   - 检查 webhook 事件是否正常接收
   - 查看日志中的错误信息

3. **使用量限制不生效**
   - 确认在转换 API 中调用了使用量检查
   - 检查订阅状态是否正确

4. **支付失败处理**
   - 检查 Stripe 仪表板中的支付状态
   - 查看 webhook 日志

## 安全考虑

1. **JWT Token 验证**：所有 API 都需要有效的 JWT token
2. **Webhook 签名验证**：确保 webhook 请求来自 Stripe
3. **敏感信息保护**：不在日志中记录敏感信息
4. **权限控制**：管理员 API 需要适当的权限验证

## 扩展功能

系统设计支持以下扩展：

1. **新订阅计划**：在配置中添加新的计划
2. **使用量类型**：支持不同类型的使用量跟踪
3. **促销代码**：集成 Stripe 促销代码
4. **多货币支持**：支持不同货币的订阅
5. **企业功能**：API 访问、批量操作等

---

本指南涵盖了订阅功能的主要使用方法。如有问题，请查看日志或联系开发团队。
